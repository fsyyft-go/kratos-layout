// Jenkins Pipeline 配置文件，用于定义持续集成流程。
pipeline {
    // 定义执行环境配置。
    agent {
        // 使用 Docker 容器作为执行环境。
        // 需要安装 docker pipeline 插件；相比 dockerContainer，提供了更简洁的语法和更多的内置功能。
        docker {
            // 指定使用 golang 1.24 版本的基础镜像。
            image 'golang:1.24'
            // 配置 Docker 容器启动参数，挂载缓存目录以提升构建性能：
            // 需要提前在 Jenkins 系统管理 -> 系统配置 -> 环境变量中配置 HOST-GO-CACHE 变量，指向本地的 go 缓存目录。
            // - 将本地的 go-build 缓存目录挂载到容器内。
            // - 将本地的 go pkg 目录挂载到容器内。
            args '-v ${HOST-GO-CACHE}/go-build:/go/cache/go-build -v ${HOST-GO-CACHE}/pkg:/go/pkg'
        }
    }
    
    // 配置环境变量。
    environment {
        // 设置 Go 语言编译缓存目录。
        GOCACHE = '/go/cache/go-build'
        // 设置 Go 语言工作目录。
        GOPATH = '/go'
        // 设置 Go 语言代理。
        GOPROXY = 'https://goproxy.cn,direct'
    }
    
    // 定义流水线各个阶段。
    stages {        
        // 测试阶段。
        stage('Test') {
            // 定义测试阶段的执行步骤。
            steps {
                // 执行 Go 语言测试命令，使用 -v 参数显示详细信息，测试所有包。
                sh 'go test -v ./...'
            }
        }
    }
}